<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peony Stores - Admin Panel</title>
<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:20px; }
h1 { text-align:center; margin-bottom:20px; }
form { max-width:600px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 6px 15px rgba(0,0,0,0.1); }
input, select { width:100%; padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
button { padding:10px 15px; margin-top:10px; border:none; background:#7f00ff; color:#fff; border-radius:6px; cursor:pointer; }
button:hover { background:#e100ff; }
table { width:100%; margin-top:30px; border-collapse: collapse; }
th, td { padding:10px; border:1px solid #ccc; text-align:left; font-size:14px; position: relative; }
th { background:#7f00ff; color:#fff; }
.status-select { width:150px; }
.filter-dropdown { position:absolute; background:#fff; border:1px solid #ccc; padding:5px; max-height:200px; overflow-y:auto; z-index:1000; }
.filter-dropdown div:hover { background:#f0f0f0; }
#adminPassModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999; }
#adminPassModal div { background:#fff; padding:30px; border-radius:12px; text-align:center; width:90%; max-width:400px; }
#secondaryPassError { color:red; margin-top:5px; display:none; }
</style>
</head>
<body>

<h1>Peony Stores - Admin Panel</h1>

<!-- Add/Edit Product Form -->
<form id="addProductForm">
  <h3 id="formTitle">Add New Product</h3>
  <input type="hidden" id="editingIndex" value="">
  <input type="text" id="productName" placeholder="Product Name" required>
  <select id="categorySelect" required>
    <option value="">Select Category</option>
    <option value="Hair Care">Hair Care</option>
    <option value="Facial & Body Care">Facial & Body Care</option>
    <option value="Body Scents">Body Scents</option>
    <option value="Wears">Wears</option>
    <option value="Food Corner">Food Corner</option>
    <option value="Others">Others</option>
  </select>
  <select id="subcategorySelect" required>
    <option value="">Select Subcategory</option>
  </select>
  <input type="text" id="colorsInput" placeholder="Colors (comma separated)">
  <input type="number" id="priceInput" placeholder="Price (₦)" required>
  <input type="number" id="stockInput" placeholder="Stock Quantity" required>
  <label>Product Image:</label>
  <input type="file" id="imageFileInput" accept="image/*">
  <input type="text" id="imageURLInput" placeholder="Or paste image URL">
  <button type="submit" id="submitBtn">Add Product</button>
</form>

<!-- Products Table -->
<h3>Products</h3>
<table id="productsTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Category</th>
      <th>Subcategory</th>
      <th>Colors</th>
      <th>Price</th>
      <th>Stock</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Orders Table -->
<h3>Orders</h3>
<label>From: <input type="date" id="csvFromDate"></label>
<label>To: <input type="date" id="csvToDate"></label>
<button onclick="downloadCSV()">Download Orders CSV</button>
<button onclick="resetAllFilters()">Reset All Filters</button>
<button id="logoutBtn" style="background:#e100ff;">Logout</button>
<table id="ordersTable">
<thead>
  <tr>
    <th data-column="id">Order ID</th>
    <th data-column="customer">Customer</th>
    <th data-column="phone">Phone</th>
    <th data-column="address">Address</th>
    <th data-column="items">Items</th>
    <th data-column="total">Total</th>
    <th data-column="status">Status</th>
    <th data-column="receipt_url">Receipt</th>
    <th data-column="date">Date</th>
  </tr>
</thead>
<tbody></tbody>
</table>

<script>

// --- PRIMARY LOGIN CHECK ---
if (localStorage.getItem("isAdminLoggedIn") !== "true") {
  alert("You must login first");
  window.location.href = "admin-auth.html";
}

// ======== CATEGORY & SUBCATEGORY ========
const subcategories = {
  "Hair Care":["Hair Extensions","Hair Products","Hair Styling Materials","Hair Maintenance Materials"],
  "Facial & Body Care":["Facial Masks","Facial & Body Care Products","Facial & Body Care Materials"],
  "Body Scents":["Perfumes","Body Mists","Body Sprays","Perfume Oil","Atomizer","Air Fresheners"],
  "Wears":["Unisex","Male","Female"],
  "Food Corner":["Edibles","Drinks","Bake It Yourself"],
  "Others":["Miscellaneous"]
};
const categorySelect = document.getElementById("categorySelect");
const subcategorySelect = document.getElementById("subcategorySelect");
categorySelect.addEventListener("change", ()=>{
  const cat = categorySelect.value;
  subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
  if(subcategories[cat]){
    subcategories[cat].forEach(sub=>{
      const opt = document.createElement("option");
      opt.value = sub; opt.textContent = sub;
      subcategorySelect.appendChild(opt);
    });
  }
});

// ======== SERVER FUNCTIONS ========
async function fetchProducts(){ const res = await fetch("/.netlify/functions/products"); return await res.json(); }
async function saveProduct(productData, editingId=null){ await fetch("/.netlify/functions/products",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({...productData, id: editingId || productData.id})}); }
async function deleteProductById(id){ await fetch(`/.netlify/functions/products?id=${id}`, { method:"DELETE" }); }
async function fetchOrders(){ const res = await fetch("/.netlify/functions/orders"); return await res.json(); }
async function updateOrderStatusServer(orderId,status){ await fetch("/.netlify/functions/orders",{ method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify({id:orderId,status}) }); }

// ======== PRODUCT MANAGEMENT ========
const addForm = document.getElementById("addProductForm");
addForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const fileInput = document.getElementById("imageFileInput");
  const urlInput = document.getElementById("imageURLInput").value.trim();
  const editingId = document.getElementById("editingIndex").value;
  function getProductData(imageData){ return {
    id: editingId || Date.now(),
    name: document.getElementById("productName").value.trim(),
    category: categorySelect.value,
    subcategory: subcategorySelect.value,
    colors: document.getElementById("colorsInput").value.split(",").map(c=>c.trim()).filter(Boolean),
    price: parseFloat(document.getElementById("priceInput").value),
    stock: parseInt(document.getElementById("stockInput").value),
    image: imageData || ""
  }; }
  if(fileInput.files && fileInput.files[0]){
    const reader = new FileReader();
    reader.onload = async function(e){
      await saveProduct(getProductData(e.target.result), editingId || null);
      resetProductForm(); renderProductsTable();
    }
    reader.readAsDataURL(fileInput.files[0]);
  } else { await saveProduct(getProductData(urlInput), editingId || null); resetProductForm(); renderProductsTable(); }
});
function resetProductForm(){ addForm.reset(); subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>'; document.getElementById("editingIndex").value = ""; document.getElementById("formTitle").textContent = "Add New Product"; document.getElementById("submitBtn").textContent = "Add Product"; }

// ======== RENDER PRODUCTS & ORDERS ========
async function renderProductsTable(){ const tbody = document.querySelector("#productsTable tbody"); const products = await fetchProducts(); tbody.innerHTML = ""; products.forEach(p=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${p.name}</td><td>${p.category}</td><td>${p.subcategory}</td><td>${(p.colors||[]).join(", ")}</td><td>₦${p.price}</td><td>${p.stock}</td><td><button onclick="editProduct(${p.id})">Edit</button><button onclick="deleteProduct(${p.id})">Delete</button></td>`; tbody.appendChild(tr); }); }
async function editProduct(id){ const products = await fetchProducts(); const p = products.find(x=>x.id==id); document.getElementById("productName").value=p.name; categorySelect.value=p.category; subcategorySelect.innerHTML='<option value="">Select Subcategory</option>'; if(subcategories[p.category]){ subcategories[p.category].forEach(sub=>{ const opt=document.createElement("option"); opt.value=sub; opt.textContent=sub; subcategorySelect.appendChild(opt); }); } subcategorySelect.value=p.subcategory; document.getElementById("colorsInput").value=(p.colors||[]).join(", "); document.getElementById("priceInput").value=p.price; document.getElementById("stockInput").value=p.stock; document.getElementById("imageURLInput").value=p.image||""; document.getElementById("editingIndex").value=p.id; document.getElementById("formTitle").textContent="Edit Product"; document.getElementById("submitBtn").textContent="Save Changes"; }
async function deleteProduct(id){ if(confirm("Are you sure you want to delete this product?")){ await deleteProductById(id); renderProductsTable(); } }
async function renderOrders(){ const tbody=document.querySelector("#ordersTable tbody"); const orders=await fetchOrders(); tbody.innerHTML=""; orders.forEach(o=>{ const tr=document.createElement("tr"); const items=o.items.map(it=>it.name).join(" | "); tr.innerHTML=`<td>${o.id}</td><td>${o.customer}</td><td>${o.phone}</td><td>${o.address||""}</td><td>${items}</td><td>₦${o.total}</td><td><select class="status-select" onchange="updateOrderStatus(${o.id}, this.value)"><option ${o.status==="PENDING"?"selected":""}>PENDING</option><option ${o.status==="AWAITING CONFIRMATION"?"selected":""}>AWAITING CONFIRMATION</option><option ${o.status==="PACKED"?"selected":""}>PACKED</option><option ${o.status==="DISPATCHED"?"selected":""}>DISPATCHED</option><option ${o.status==="COMPLETED"?"selected":""}>COMPLETED</option></select></td><td>${o.receipt_url||""}</td><td>${o.date}</td>`; tbody.appendChild(tr); }); }
async function updateOrderStatus(orderId,newStatus){ await updateOrderStatusServer(orderId,newStatus); renderOrders(); }

// ======== CSV ========
async function downloadCSV(){
  const orders=await fetchOrders();
  if(orders.length===0){ alert("No orders to download"); return; }
  const fromDate=document.getElementById("csvFromDate").value;
  const toDate=document.getElementById("csvToDate").value;
  const filteredOrders=orders.filter(o=>{ const orderDate=new Date(o.date); let include=true; if(fromDate && orderDate<new Date(fromDate+"T00:00:00")) include=false; if(toDate && orderDate>new Date(toDate+"T23:59:59")) include=false; return include; });
  if(filteredOrders.length===0){ alert("No orders in the selected date range"); return; }
  let csv="Order ID,Customer,Phone,Address,Items,Total,Status,Receipt,Date\n";
  filteredOrders.forEach(o=>{ const items=o.items.map(it=>it.name+(it.color?` (${it.color})`:'')+` x${it.quantity}`).join(" | "); csv+=`"${o.id}","${o.customer}","${o.phone}","${o.address||""}","${items}","${o.total}","${o.status}","${o.receipt_url||''}","${o.date}"\n`; });
  const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`PeonyOrders_${new Date().toISOString().split("T")[0]}.csv`; a.click(); URL.revokeObjectURL(url);
}

// ======== FILTERS ========
const activeFilters={};
function setupExcelFilters(){ /* keep existing code */ }
function showFilterDropdown(column, th){ /* keep existing code */ }
function filterExcel(){ /* keep existing code */ }
function resetAllFilters(){ for(const col in activeFilters) activeFilters[col]=null; filterExcel(); }

// ======== INIT ========
renderProductsTable();
renderOrders();
setupExcelFilters();
setInterval(async ()=>{ await renderOrders(); filterExcel(); },1500);

// ======== LOGOUT & SECONDARY PASSWORD ========
const logoutBtn=document.getElementById("logoutBtn");
logoutBtn.addEventListener("click", ()=>{
  const pass = prompt("Enter secondary admin password");

  if (pass === "peony2026") {
    localStorage.removeItem("isAdminLoggedIn");
    window.location.href = "admin-auth.html";
  } else {
    alert("Incorrect secondary password");
  }
});

</script>
</body>
</html>
